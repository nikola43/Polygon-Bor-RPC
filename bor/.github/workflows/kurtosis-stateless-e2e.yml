name: Kurtosis Stateless E2E Tests

on:
  push:
    branches:
      - 'master'
      - 'develop'
  pull_request:
    branches:
      - 'master'
      - 'develop'
    types: [opened, synchronize]

concurrency:
  group: kurtosis-stateless-e2e-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  ENCLAVE_NAME: kurtosis-stateless-e2e
  POLYCLI_VERSION: v0.1.103

jobs:
  build-bor:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout bor
        uses: actions/checkout@v5

      - name: Build bor docker image
        run: docker build -t bor:local --file Dockerfile .

      - name: Save bor docker image
        run: docker save bor:local | gzip > bor-image.tar.gz

      - name: Upload bor docker image
        uses: actions/upload-artifact@v4
        with:
          name: bor-image
          path: bor-image.tar.gz
          retention-days: 1

  build-heimdall-v2:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout heimdall-v2
        uses: actions/checkout@v5
        with:
          repository: 0xPolygon/heimdall-v2
          ref: develop

      - name: Build heimdall-v2 docker image
        run: docker build -t heimdall-v2:local --file Dockerfile .

      - name: Save heimdall-v2 docker image
        run: docker save heimdall-v2:local | gzip > heimdall-v2-image.tar.gz

      - name: Upload heimdall-v2 docker image
        uses: actions/upload-artifact@v4
        with:
          name: heimdall-v2-image
          path: heimdall-v2-image.tar.gz
          retention-days: 1

  e2e-tests:
    needs:
      - build-bor
      - build-heimdall-v2
    runs-on: ubuntu-latest
    timeout-minutes: 45
    # These permissions are required to log in to GCR
    permissions:
      contents: read
      actions: write
      id-token: write
    steps:
      # Set up kurtosis
      - name: Checkout kurtosis-pos
        uses: actions/checkout@v5
        with:
          repository: 0xPolygon/kurtosis-pos
          ref: hv2/eip1559-and-rio-at-128

      # This step will free disk space and thus remove any docker images previously built
      - name: Pre kurtosis run
        uses: ./.github/actions/setup
        with:
          main_branch: develop
          docker_username: ${{ secrets.DOCKERHUB }}
          docker_token: ${{ secrets.DOCKERHUB_KEY }}

      - name: Configure Docker API compatibility for Pumba
        run: |
          # Pumba uses Docker SDK v23.0.3 (API v1.42), but Docker 29+ requires minimum API v1.44
          # Lower the daemon's minimum API version to maintain compatibility
          if [ -f /etc/docker/daemon.json ]; then
            sudo jq '. + {"min-api-version": "1.42"}' /etc/docker/daemon.json | sudo tee /etc/docker/daemon.json.tmp > /dev/null
            sudo mv /etc/docker/daemon.json.tmp /etc/docker/daemon.json
          else
            echo '{"min-api-version": "1.42"}' | sudo tee /etc/docker/daemon.json > /dev/null
          fi
          sudo systemctl restart docker

      - name: Checkout pos-workflows
        uses: actions/checkout@v5
        with:
          repository: 0xPolygon/pos-workflows
          ref: main
          path: pos-workflows

      - name: Copy kurtosis config
        run: cp ./pos-workflows/configs/kurtosis-stateless-e2e.yml ./kurtosis-stateless-e2e.yml

      # Load images
      - name: Download bor docker image
        uses: actions/download-artifact@v4
        with:
          name: bor-image

      - name: Download heimdall-v2 docker image
        uses: actions/download-artifact@v4
        with:
          name: heimdall-v2-image

      - name: Load bor docker image
        run: |
          gunzip -c bor-image.tar.gz | docker load
          echo "Loaded bor docker image:"
          docker images bor:local --format "{{.ID}} {{.CreatedAt}}"

      - name: Load heimdall-v2 docker image
        run: |
          gunzip -c heimdall-v2-image.tar.gz | docker load
          echo "Loaded heimdall-v2 docker image:"
          docker images heimdall-v2:local --format "{{.ID}} {{.CreatedAt}}"

      # Deploy kurtosis enclave
      - name: Kurtosis run
        run: kurtosis run --args-file=kurtosis-stateless-e2e.yml --enclave ${{ env.ENCLAVE_NAME }} .

      - name: Inspect enclave
        run: kurtosis enclave inspect ${{ env.ENCLAVE_NAME }}

      # Run e2e tests
      - name: Install polycli
        run: |
          tmp_dir=$(mktemp -d)
          curl -L https://github.com/0xPolygon/polygon-cli/releases/download/${{ env.POLYCLI_VERSION }}/polycli_${{ env.POLYCLI_VERSION }}_linux_amd64.tar.gz | tar -xz -C "$tmp_dir"
          mv "$tmp_dir"/* /usr/local/bin/polycli
          rm -rf "$tmp_dir"
          sudo chmod +x /usr/local/bin/polycli
          polycli version

      - name: Run stateless e2e tests
        id: stateless-tests
        working-directory: pos-workflows/tests/stateless_tests
        run: bash kurtosis_stateless_test.sh

      # Collect diagnostics on failure
      - name: Collect network diagnostics and state dump
        if: always() && steps.stateless-tests.outcome == 'failure'
        uses: ./pos-workflows/.github/actions/network-diagnostics-and-state-dump
        with:
          enclave_name: ${{ env.ENCLAVE_NAME }}

      # Clean up
      - name: Post kurtosis run
        if: always()
        uses: ./.github/actions/cleanup
        with:
          main_branch: develop
          enclave_name: ${{ env.ENCLAVE_NAME }}
